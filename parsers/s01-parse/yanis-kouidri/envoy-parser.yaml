filter: "evt.Parsed.program == 'envoy'"
onsuccess: next_stage
name: yanis-kouidri/envoy-parser
description: envoy json logs parser
nodes:
  - filter: TrimSpace(evt.Parsed.message) startsWith "{" && UnmarshalJSON(evt.Parsed.message, evt.Unmarshaled, "envoy") in ["", nil]
    statics:
      - target: evt.StrTime
        expression: evt.Unmarshaled.envoy.start_time
      - parsed: raw_remote_addr
        expression: evt.Unmarshaled.envoy.downstream_remote_address
      - parsed: remote_addr
        expression: "evt.Unmarshaled.envoy.downstream_remote_address != nil ? Split(evt.Unmarshaled.envoy.downstream_remote_address, ':')[0] : nil"
      - parsed: request
        expression: evt.Unmarshaled.envoy["x-envoy-origin-path"]
      - parsed: verb
        expression: evt.Unmarshaled.envoy.method
      - parsed: status
        expression: "evt.Unmarshaled.envoy.response_code != nil ? int(evt.Unmarshaled.envoy.response_code) : nil"
      - parsed: http_user_agent
        expression: evt.Unmarshaled.envoy["user-agent"]
      - parsed: target_fqdn
        expression: evt.Unmarshaled.envoy[":authority"]
statics:
  - meta: service
    value: http
  - meta: log_type
    value: http_access-log
  - meta: source_ip
    expression: "evt.Parsed.remote_addr"
  - meta: http_path
    expression: "evt.Parsed.request"
  - meta: http_verb
    expression: "evt.Parsed.verb"
  - meta: http_status
    expression: "evt.Parsed.status"
  - meta: http_user_agent
    expression: "evt.Parsed.http_user_agent"
  - meta: target_fqdn
    expression: "evt.Parsed.target_fqdn"
