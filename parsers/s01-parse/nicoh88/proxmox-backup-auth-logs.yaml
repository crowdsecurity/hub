name: nicoh88/proxmox-backup-auth-logs
description: "Parse Proxmox Backup Server API auth.log for bruteforce attempts"

# passt zu non-syslog-Ausgabe: evt.Parsed.program = proxmox-backup-auth
filter: "evt.Parsed.program == 'proxmox-backup-auth'"

onsuccess: next_stage

pattern_syntax:
  PBS_AUTH_FAIL: '%{TIMESTAMP_ISO8601:ts}: authentication failure; rhost=\[::ffff:%{IP:client_ip}\]:%{NUMBER:client_port} user=%{USERNAME:source_user}@%{WORD:realm} msg=%{GREEDYDATA:fail_reason}'
  PBS_AUTH_OK:   '%{TIMESTAMP_ISO8601:ts}: successful auth for user ''%{USERNAME:source_user}@%{WORD:realm}'''

nodes:
  - grok:
      name: PBS_AUTH_FAIL
      apply_on: message
      statics:
        - target: evt.StrTime
          expression: evt.Parsed.ts
        - meta: log_type
          value: pbs_failed-auth
        - meta: source_user
          expression: evt.Parsed.source_user
        - meta: service
          value: proxmox-backup-api
        - meta: source_ip
          expression: evt.Parsed.client_ip

  - grok:
      name: PBS_AUTH_OK
      apply_on: message
      statics:
        - target: evt.StrTime
          expression: evt.Parsed.ts
        - meta: log_type
          value: pbs_success-auth
        - meta: source_user
          expression: evt.Parsed.source_user
        - meta: service
          value: proxmox-backup-api

