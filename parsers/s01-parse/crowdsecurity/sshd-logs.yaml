onsuccess: next_stage
#debug: true
filter: "evt.Parsed.program == 'sshd'"
name: crowdsecurity/sshd-logs
description: "Parse openSSH logs"
pattern_syntax:
  SSHD_AUTH_FAIL: 'pam_%{DATA:pam_type}\(sshd:auth\): authentication failure; logname= uid=%{NUMBER:uid}? euid=%{NUMBER:euid}? tty=ssh ruser= rhost=%{IP:sshd_client_ip}( %{SPACE}user=%{USERNAME:sshd_invalid_user})?'
  SSHD_MAGIC_VALUE_FAILED: 'Magic value check failed \(\d+\) on obfuscated handshake from %{IP:sshd_client_ip} port \d+'
  SSHD_INVALID_USER: 'Invalid user\s*%{USERNAME:sshd_invalid_user}? from %{IP:sshd_client_ip}( port \d+)?'
  SSHD_INVALID_BANNER: 'banner exchange: Connection from %{IP:sshd_client_ip} port \d+: invalid format'
  SSHD_PREAUTH_AUTHENTICATING_USER: 'Connection closed by (authenticating|invalid) user %{USERNAME:sshd_invalid_user} %{IP:sshd_client_ip} port \d+ \[preauth\]'
  #following: https://github.com/crowdsecurity/crowdsec/issues/1201 - some scanners behave differently and trigger this one
  SSHD_PREAUTH_AUTHENTICATING_USER_ALT: 'Disconnected from (authenticating|invalid) user %{USERNAME:sshd_invalid_user} %{IP:sshd_client_ip} port \d+ \[preauth\]'
  SSHD_BAD_KEY_NEGOTIATION: 'Unable to negotiate with %{IP:sshd_client_ip} port \d+: no matching (host key type|key exchange method|MAC) found.'
nodes:
  - grok:
      name: "SSHD_FAIL"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_failed-auth
        - meta: target_user
          expression: "evt.Parsed.sshd_invalid_user"
  - grok:
      name: "SSHD_PREAUTH_AUTHENTICATING_USER_ALT"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_failed-auth
        - meta: target_user
          expression: "evt.Parsed.sshd_invalid_user"
  - grok:
      name: "SSHD_PREAUTH_AUTHENTICATING_USER"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_failed-auth
        - meta: target_user
          expression: "evt.Parsed.sshd_invalid_user"
  - grok:
      name: "SSHD_DISC_PREAUTH"
      apply_on: message
  - grok:
      name: "SSHD_BAD_VERSION"
      apply_on: message
  - grok:
      name: "SSHD_INVALID_USER"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_failed-auth
        - meta: target_user
          expression: "evt.Parsed.sshd_invalid_user"
  - grok:
      name: "SSHD_INVALID_BANNER"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_failed-auth
        - meta: extra_log_type
          value: ssh_bad_banner
  - grok:
      name: "SSHD_USER_FAIL"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_failed-auth
        - meta: target_user
          expression: "evt.Parsed.sshd_invalid_user"
  - grok: 
      name: "SSHD_AUTH_FAIL"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_failed-auth
        - meta: target_user
          expression: "evt.Parsed.sshd_invalid_user"
  - grok: 
      name: "SSHD_MAGIC_VALUE_FAILED"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_failed-auth
        - meta: target_user
          expression: "evt.Parsed.sshd_invalid_user"
  - grok:
      name: "SSHD_BAD_KEY_NEGOTIATION"
      apply_on: message
      statics:
        - meta: log_type
          value: ssh_bad_keyexchange
statics:
    - meta: service
      value: ssh
    - meta: source_ip
      expression: "evt.Parsed.sshd_client_ip"
