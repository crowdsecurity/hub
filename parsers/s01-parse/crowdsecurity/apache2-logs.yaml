#Apache access logs
debug: true
filter: "evt.Parsed.program startsWith 'apache2'"
onsuccess: next_stage
name: crowdsecurity/apache2-logs
description: "Parse Apache2 access and error logs"
#log line can be prefixed by a target_fqdn

nodes:
  - grok:
      pattern: '(%{IPORHOST:target_fqdn} )?%{COMMONAPACHELOG} %{QS:referrer} %{QS:agent}'
      apply_on: message
      # these ones apply for both grok patterns
      statics:
        - meta: log_type
          value: http_access-log
        - target: evt.StrTime
          expression: evt.Parsed.timestamp
        - meta: service
          value: http
        - meta: source_ip
          expression: evt.Parsed.clientip
        - meta: http_status
          expression: evt.Parsed.response
        - meta: http_path
          expression: evt.Parsed.request
  - grok:
      pattern: '%{HTTPD_ERRORLOG}'
      apply_on: message
    nodes:
      - filter: "evt.Parsed.module == 'auth_basic'"
        pattern_syntax:
          NOT_DOUBLE_POINT: '[^:]+'
          NOT_DOUBLE_QUOTE: '[^"]+'
          EXTRACT_USER: 'user %{NOT_DOUBLE_POINT:username}: authentication failure for "%{NOT_DOUBLE_QUOTE:target_uri}": Password Mismatch'
        grok:
          pattern: '%{EXTRACT_USER}'
          apply_on: message
          # these ones apply for both grok patterns
          statics:
            - meta: username
              expression: evt.Parsed.username
            - meta: target_uri
              expression: evt.Parsed.target_uri
            - meta: type
              expression: "auth_fail"
      - filter: "evt.Parsed.module == 'authz_core' && evt.Parsed.message contains 'client denied'"
        statics:
          - meta: username
            expression: evt.Parsed.username
          - meta: target_uri
            expression: evt.Parsed.target_uri
          - meta: type
            expression: "permission_denied"
    statics:
      - meta: log_type
        value: http_error-log
      - target: evt.StrTime
        expression: evt.Parsed.timestamp
      - meta: service
        value: http
      - meta: source_ip
        expression: evt.Parsed.client
      - meta: http_status
        expression: evt.Parsed.response
      - meta: http_path
        expression: evt.Parsed.request
      