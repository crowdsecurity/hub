#type=SYSCALL msg=audit(1672330955.273:4433): arch=c000003e syscall=263 success=no exit=-2 a0=ffffff9c a1=557162396590 a2=0 a3=0 items=1 ppid=144571 pid=145400 auid=1000 uid=1000 gid=1000 euid=1000 suid=1000 fsuid=1000 egid=1000 sgid=1000 fsgid=1000 tty=pts0 ses=79 comm="rm" exe="/usr/bin/rm" key="file_modification"
name: crowdsecurity/auditd-logs
debug: true
description: "Parse auditd logs"
filter: "evt.Parsed.program == 'auditd'"
onsuccess: next_stage
pattern_syntax:
  HEXSTR: '[a-f0-9]+'
  FLOAT: '[0-9\.]+'
  AUDITD_QUOTED: '[^"]+|\(none\)|\(null\)'
  AUDITD_GENERIC_PREFIX: '^type=%{WORD:type} msg=%{WORD:msg_type}\(%{FLOAT:timestamp}:%{INT:event_inc_id}\): %{DATA:auditd_message}$'
  AUDITD_SYSCALL: '^arch=%{HEXSTR:arch} syscall=%{INT:syscall_number} success=%{WORD:success} exit=%{INT:exit} %{DATA:syscall_args_unparsed} items=%{INT:items} ppid=%{INT:ppid} pid=%{INT:pid} auid=%{INT:auid} uid=%{INT:uid} gid=%{INT:gid} euid=%{INT:euid} suid=%{INT:suid} fsuid=%{INT:fsuid} egid=%{INT:egid} sgid=%{INT:sgid} fsgid=%{INT:fsgid} tty=%{DATA:tty} ses=%{INT:session} comm="%{DATA:comm}" exe="%{DATA:exe}" key=%{DATA:key}$'
#parse the generic part, and deal with it if relevant
grok:
  name: AUDITD_GENERIC_PREFIX
  apply_on: message
nodes:
  #SYSCALL 59 on x86_64 -> execve
  - filter: 'evt.Parsed.type == "SYSCALL" and evt.Parsed.auditd_message contains "arch=c000003e syscall=59"'
    grok:
      name: AUDITD_SYSCALL
      apply_on: auditd_message
    statics:
      - meta: log_type
        value: auditd_execve
      - target: evt.StrTime
        expression: evt.Parsed.timestamp
      - meta: exe
        expression: evt.Parsed.exe
      - meta: uid
        expression: evt.Parsed.uid
      - meta: auditd_eventid
        expression: evt.Parsed.event_inc_id
      #let's hydrate with ppid process if we can :)
      - target: evt.Meta.parent_progname
        expression: GetFromStash("auditd_pid_progname", evt.Parsed.ppid)
    #let's capture process name if we can
    stash:
      - name: auditd_pid_progname
        key: evt.Parsed.pid
        value: evt.Parsed.exe
        ttl: 1m
        size: 100      
