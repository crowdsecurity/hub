#
# Parse web service of [Sympa - Mailing List Management Software](https://www.sympa.community/)
# and extract some cases:
# - Unknown action "xyz"
# - Unknown list "xyz"
# These cases are not present in http_access_log as 404 because Sympa replies with HTTP 200 and an user html error message.
#
# acquistion examples:
#
# ```yaml
# filenames:
#  - /var/log/sympa.log
# labels:
#   type: syslog
# ```
#
# ```yaml
# source: journalctl
# journalctl_filter:
#  - "_SYSTEMD_UNIT=wwsympa.service"
# labels:
#   type: syslog
# ```
#
# Docs:
# - [Parser creation : skeleton](https://docs.crowdsec.net/docs/next/log_processor/parsers/create/#parser-creation--skeleton)
# - [expression language](https://expr-lang.org/docs/language-definition)
#
# Version: 2025-11-09
#
name: cyrille37/sympa_ww-logs
description: "Parse wwsympa syslog lines"
stage: s01-parse

#filter: "evt.Line matches \"wwsympa\""
#filter: "evt.Parsed.program startsWith 'wwsympa'"
filter: evt.Parsed.program == 'wwsympa'
onsuccess: next_stage
nodes:
  - grok:
      pattern: '%{WORD:sympa_loglevel} %{GREEDYDATA:sympa_where_action} (?:\[robot %{DATA:sympa_robot}\]) (?:\[session %{DATA:sympa_session}\]) (?:\[client %{IPORHOST:sympa_client_ip}\])( %{GREEDYDATA:sympa_message})?'
      #apply_on: Line.Raw
      apply_on: message
      # statics : on d√©clare un log_type et on transforme le timestamp en Time
      statics:
        #  - meta: log_type
        #    value: sympa_ww
        #  - target: evt.StrTime
        #    expression: evt.Parsed.time_local
        - meta: service
          value: sympa
    nodes:
      - filter: "evt.Parsed.sympa_message contains 'Unknown action'"
        statics:
          - meta: sympa_warn
            value: unknow-action
      - filter: "evt.Parsed.sympa_message contains 'Unknown list'"
        statics:
          - meta: sympa_warn
            value: unknow-list

statics:
  - meta: service
    value: sympa
  #- target: evt.StrTime
  #  expression: "evt.StrTime"
  - meta: source_ip
    expression: "evt.Parsed.sympa_client_ip"
  - meta: sympa_where_action
    expression: "evt.Parsed.sympa_where_action"
  - meta: sympa_robot
    expression: "evt.Parsed.sympa_robot"
  # force a value, if not matched it will be empty, but set.
  - meta: sympa_warn
    expression: "evt.Meta.sympa_warn"

