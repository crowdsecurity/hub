type: conditional
name: crowdsecurity/auditd-postexploit-exec-from-net
description: "Detect post-exploitation behaviour : curl/wget and exec"
filter: evt.Meta.log_type == 'auditd_execve'
#grouping by ppid to track a process doing those action in a short timeframe
groupby: evt.Unmarshaled.auditd.ppid
condition: |
  any(queue.Queue, {.Unmarshaled.auditd.exe in ["/usr/bin/wget", "/usr/bin/curl"]}) 
  and (
    any(queue.Queue, { !(.Unmarshaled.auditd.exe startsWith "/usr/" or .Unmarshaled.auditd.exe startsWith "/bin/" or .Unmarshaled.auditd.exe startsWith "/sbin/")})
    or any(queue.Queue, { .Unmarshaled.auditd.exe in ["/bin/sh", "/bin/bash", "/bin/dash"] })
  )
leakspeed: 1s
capacity: -1
blackhole: 1m
labels:
  service: linux
  type: post-exploitation
  remediation: false
scope:
  type: pid
  expression: evt.Unmarshaled.auditd.ppid
