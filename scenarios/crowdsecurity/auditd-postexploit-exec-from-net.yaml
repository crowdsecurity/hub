type: conditional
#debug: true
name: crowdsecurity/auditd-postexploit-exec-from-net
description: "Detect post-exploitation behaviour : curl/wget and exec"
filter: evt.Meta.log_type == 'auditd_execve'
#grouping by ppid to track on process doing a lot of invocations to rm, such as a shell script
groupby: evt.Parsed.ppid
condition: |
  any(queue.Queue, {.Parsed.exe in ["/usr/bin/wget", "/usr/bin/curl"]}) 
  and (
    any(queue.Queue, { !(.Parsed.exe startsWith "/usr/" or .Parsed.exe startsWith "/bin/" or .Parsed.exe startsWith "/sbin/")})
    or any(queue.Queue, { .Parsed.exe in ["/bin/sh", "/bin/bash", "/bin/dash"] })
  )
leakspeed: 1s
capacity: -1
blackhole: 1m
labels:
  service: linux
  type: post-exploitation
  remediation: false
scope:
  type: pid
  expression: evt.Parsed.ppid
