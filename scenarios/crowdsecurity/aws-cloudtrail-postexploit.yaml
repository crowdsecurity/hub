type: conditional
name: crowdsecurity/aws-cloudtrail-postexploit
description: "postexploitation detection (noisy)"
#debug: true
capacity: -1
leakspeed: 1m
distinct: evt.Meta.event_name
filter: evt.Meta.log_type == 'aws-cloudtrail'
condition: |
  count(queue.Queue, #.Meta.event_name in ["ListUserPolicies", "ListPolicies", "ListBuckets", "ListApplications", "DescribeInstances", "GetCallerIdentity", "GetFunctions", "DescribeAccountAttributes", "ListResources"] or #.Meta.event_name startsWith "ListFunctions") > 2
blackhole: 1m
reprocess: true
groupby: evt.Meta.source_ip
scope:
  type: AwsARN
  expression: evt.Meta.user_arn
labels:
  confidence: 3
  spoofable: 0
  classification:
    - attack.T1087
    - attack.T1526
  behavior: "cloud:audit"
  label: "AWS post-exploitation detection"
  service: aws
  cti: false
  remediation: false
