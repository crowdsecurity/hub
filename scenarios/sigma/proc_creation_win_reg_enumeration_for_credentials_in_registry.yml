type: trigger
name: sigma/proc_creation_win_reg_enumeration_for_credentials_in_registry
description: |
  Adversaries may search the Registry on compromised systems for insecurely stored credentials.
  The Windows Registry stores configuration information that can be used by the system or other programs.
  Adversaries may query the Registry looking for credentials and passwords that have been stored for use by other programs or services
  
filter: |
  (evt.Meta.service == 'sysmon' && evt.Parsed.EventID == '1') && (evt.Parsed.Image endsWith '\\reg.exe' && evt.Parsed.CommandLine contains ' query ' && evt.Parsed.CommandLine contains '/t ' && evt.Parsed.CommandLine contains 'REG_SZ' && evt.Parsed.CommandLine contains '/s' && (evt.Parsed.CommandLine contains '/f ' && evt.Parsed.CommandLine contains 'HKLM' || evt.Parsed.CommandLine contains '/f ' && evt.Parsed.CommandLine contains 'HKCU' || evt.Parsed.CommandLine contains 'HKCU\\Software\\SimonTatham\\PuTTY\\Sessions'))
blackhole: 2m
#status: test
labels:
  service: windows
  confidence: 1
  spoofable: 0
#  classification:
#  - attack.t1552.002

  label: "Enumeration for Credentials in Registry"
  behavior : "windows:audit"
  remediation: false

scope:
  type: ParentProcessId
  expression: evt.Parsed.ParentProcessId

