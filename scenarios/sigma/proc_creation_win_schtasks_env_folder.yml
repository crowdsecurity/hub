type: trigger
name: sigma/proc_creation_win_schtasks_env_folder
description: |
  Detects Schtask creations that point to a suspicious folder or an environment variable often used by malware
filter: |
  (evt.Meta.service == 'sysmon' && evt.Parsed.EventID == '1') && ((evt.Parsed.Image endsWith '\\schtasks.exe' && evt.Parsed.CommandLine contains ' /create ' && (evt.Parsed.CommandLine contains '%AppData%' || evt.Parsed.CommandLine contains '\\AppData\\Local\\' || evt.Parsed.CommandLine contains '\\AppData\\Roaming\\' || evt.Parsed.CommandLine contains '%Public%' || evt.Parsed.CommandLine contains '\\Users\\Public' || evt.Parsed.CommandLine contains 'C:\\Windows\\Temp' || evt.Parsed.CommandLine contains 'C:\\Perflogs') || evt.Parsed.ParentCommandLine endsWith '\\svchost.exe -k netsvcs -p -s Schedule' && (evt.Parsed.CommandLine contains '%Public%' || evt.Parsed.CommandLine contains '\\Users\\Public' || evt.Parsed.CommandLine contains 'C:\\Windows\\Temp' || evt.Parsed.CommandLine contains 'C:\\Perflogs')) && not (evt.Parsed.CommandLine contains 'update_task.xml' || evt.Parsed.CommandLine contains '/Create /TN TVInstallRestore /TR' || evt.Parsed.ParentCommandLine contains 'unattended.ini' || evt.Parsed.CommandLine contains '/Create /Xml "C:\\Users\\' && evt.Parsed.CommandLine contains '\\AppData\\Local\\Temp\\.CR.' && evt.Parsed.CommandLine contains 'Avira_Security_Installation.xml' || evt.Parsed.CommandLine contains '/Create /F /TN' && evt.Parsed.CommandLine contains '/Xml ' && evt.Parsed.CommandLine contains '\\AppData\\Local\\Temp\\is-' && evt.Parsed.CommandLine contains 'Avira_' && (evt.Parsed.CommandLine contains '.tmp\\UpdateFallbackTask.xml' || evt.Parsed.CommandLine contains '.tmp\\WatchdogServiceControlManagerTimeout.xml' || evt.Parsed.CommandLine contains '.tmp\\SystrayAutostart.xml' || evt.Parsed.CommandLine contains '.tmp\\MaintenanceTask.xml') || evt.Parsed.CommandLine contains '\\AppData\\Local\\Temp\\' && evt.Parsed.CommandLine contains '/Create /TN "klcp_update" /XML ' && evt.Parsed.CommandLine contains '\\klcp_update_task.xml'))
blackhole: 2m
#status: experimental
labels:
  service: windows
  confidence: 0
  spoofable: 0
#  classification:
#  - attack.t1053.005

  label: "Suspicious Schtasks From Env Var Folder"
  behavior : "windows:audit"
  remediation: false

scope:
  type: ParentProcessId
  expression: evt.Parsed.ParentProcessId

