type: trigger
name: sigma/proc_creation_win_powershell_malicious_cmdlets
description: |
  Detects Commandlet names from well-known PowerShell exploitation frameworks
filter: |
  (evt.Meta.service == 'sysmon' && evt.Parsed.EventID == '1') && (evt.Parsed.CommandLine contains 'Add-Exfiltration' || evt.Parsed.CommandLine contains 'Add-Persistence' || evt.Parsed.CommandLine contains 'Add-RegBackdoor' || evt.Parsed.CommandLine contains 'Add-RemoteRegBackdoor' || evt.Parsed.CommandLine contains 'Add-ScrnSaveBackdoor' || evt.Parsed.CommandLine contains 'Check-VM' || evt.Parsed.CommandLine contains 'ConvertTo-Rc4ByteStream' || evt.Parsed.CommandLine contains 'Decrypt-Hash' || evt.Parsed.CommandLine contains 'Disable-ADIDNSNode' || evt.Parsed.CommandLine contains 'Disable-MachineAccount' || evt.Parsed.CommandLine contains 'Do-Exfiltration' || evt.Parsed.CommandLine contains 'Enable-ADIDNSNode' || evt.Parsed.CommandLine contains 'Enable-MachineAccount' || evt.Parsed.CommandLine contains 'Enabled-DuplicateToken' || evt.Parsed.CommandLine contains 'Exploit-Jboss' || evt.Parsed.CommandLine contains 'Export-ADR' || evt.Parsed.CommandLine contains 'Export-ADRCSV' || evt.Parsed.CommandLine contains 'Export-ADRExcel' || evt.Parsed.CommandLine contains 'Export-ADRHTML' || evt.Parsed.CommandLine contains 'Export-ADRJSON' || evt.Parsed.CommandLine contains 'Export-ADRXML' || evt.Parsed.CommandLine contains 'Find-Fruit' || evt.Parsed.CommandLine contains 'Find-GPOLocation' || evt.Parsed.CommandLine contains 'Find-TrustedDocuments' || evt.Parsed.CommandLine contains 'Get-ADIDNS' || evt.Parsed.CommandLine contains 'Get-ApplicationHost' || evt.Parsed.CommandLine contains 'Get-ChromeDump' || evt.Parsed.CommandLine contains 'Get-ClipboardContents' || evt.Parsed.CommandLine contains 'Get-FoxDump' || evt.Parsed.CommandLine contains 'Get-GPPPassword' || evt.Parsed.CommandLine contains 'Get-IndexedItem' || evt.Parsed.CommandLine contains 'Get-KerberosAESKey' || evt.Parsed.CommandLine contains 'Get-Keystrokes' || evt.Parsed.CommandLine contains 'Get-LSASecret' || evt.Parsed.CommandLine contains 'Get-MachineAccountAttribute' || evt.Parsed.CommandLine contains 'Get-MachineAccountCreator' || evt.Parsed.CommandLine contains 'Get-PassHashes' || evt.Parsed.CommandLine contains 'Get-RegAlwaysInstallElevated' || evt.Parsed.CommandLine contains 'Get-RegAutoLogon' || evt.Parsed.CommandLine contains 'Get-RemoteBootKey' || evt.Parsed.CommandLine contains 'Get-RemoteCachedCredential' || evt.Parsed.CommandLine contains 'Get-RemoteLocalAccountHash' || evt.Parsed.CommandLine contains 'Get-RemoteLSAKey' || evt.Parsed.CommandLine contains 'Get-RemoteMachineAccountHash' || evt.Parsed.CommandLine contains 'Get-RemoteNLKMKey' || evt.Parsed.CommandLine contains 'Get-RickAstley' || evt.Parsed.CommandLine contains 'Get-Screenshot' || evt.Parsed.CommandLine contains 'Get-SecurityPackages' || evt.Parsed.CommandLine contains 'Get-ServiceFilePermission' || evt.Parsed.CommandLine contains 'Get-ServicePermission' || evt.Parsed.CommandLine contains 'Get-ServiceUnquoted' || evt.Parsed.CommandLine contains 'Get-SiteListPassword' || evt.Parsed.CommandLine contains 'Get-System' || evt.Parsed.CommandLine contains 'Get-TimedScreenshot' || evt.Parsed.CommandLine contains 'Get-UnattendedInstallFile' || evt.Parsed.CommandLine contains 'Get-Unconstrained' || evt.Parsed.CommandLine contains 'Get-USBKeystrokes' || evt.Parsed.CommandLine contains 'Get-VaultCredential' || evt.Parsed.CommandLine contains 'Get-VulnAutoRun' || evt.Parsed.CommandLine contains 'Get-VulnSchTask' || evt.Parsed.CommandLine contains 'Grant-ADIDNSPermission' || evt.Parsed.CommandLine contains 'Gupt-Backdoor' || evt.Parsed.CommandLine contains 'HTTP-Login' || evt.Parsed.CommandLine contains 'Install-ServiceBinary' || evt.Parsed.CommandLine contains 'Install-SSP' || evt.Parsed.CommandLine contains 'Invoke-ACLScanner' || evt.Parsed.CommandLine contains 'Invoke-ADRecon' || evt.Parsed.CommandLine contains 'Invoke-ADSBackdoor' || evt.Parsed.CommandLine contains 'Invoke-AgentSmith' || evt.Parsed.CommandLine contains 'Invoke-AllChecks' || evt.Parsed.CommandLine contains 'Invoke-ARPScan' || evt.Parsed.CommandLine contains 'Invoke-AzureHound' || evt.Parsed.CommandLine contains 'Invoke-BackdoorLNK' || evt.Parsed.CommandLine contains 'Invoke-BadPotato' || evt.Parsed.CommandLine contains 'Invoke-BetterSafetyKatz' || evt.Parsed.CommandLine contains 'Invoke-BypassUAC' || evt.Parsed.CommandLine contains 'Invoke-Carbuncle' || evt.Parsed.CommandLine contains 'Invoke-Certify' || evt.Parsed.CommandLine contains 'Invoke-ConPtyShell' || evt.Parsed.CommandLine contains 'Invoke-CredentialInjection' || evt.Parsed.CommandLine contains 'Invoke-DAFT' || evt.Parsed.CommandLine contains 'Invoke-DCSync' || evt.Parsed.CommandLine contains 'Invoke-DinvokeKatz' || evt.Parsed.CommandLine contains 'Invoke-DllInjection' || evt.Parsed.CommandLine contains 'Invoke-DNSUpdate' || evt.Parsed.CommandLine contains 'Invoke-DomainPasswordSpray' || evt.Parsed.CommandLine contains 'Invoke-DowngradeAccount' || evt.Parsed.CommandLine contains 'Invoke-EgressCheck' || evt.Parsed.CommandLine contains 'Invoke-Eyewitness' || evt.Parsed.CommandLine contains 'Invoke-FakeLogonScreen' || evt.Parsed.CommandLine contains 'Invoke-Farmer' || evt.Parsed.CommandLine contains 'Invoke-Get-RBCD-Threaded' || evt.Parsed.CommandLine contains 'Invoke-Gopher' || evt.Parsed.CommandLine contains 'Invoke-Grouper' || evt.Parsed.CommandLine contains 'Invoke-HandleKatz' || evt.Parsed.CommandLine contains 'Invoke-ImpersonatedProcess' || evt.Parsed.CommandLine contains 'Invoke-ImpersonateSystem' || evt.Parsed.CommandLine contains 'Invoke-InteractiveSystemPowerShell' || evt.Parsed.CommandLine contains 'Invoke-Internalmonologue' || evt.Parsed.CommandLine contains 'Invoke-Inveigh' || evt.Parsed.CommandLine contains 'Invoke-InveighRelay' || evt.Parsed.CommandLine contains 'Invoke-KrbRelay' || evt.Parsed.CommandLine contains 'Invoke-LdapSignCheck' || evt.Parsed.CommandLine contains 'Invoke-Lockless' || evt.Parsed.CommandLine contains 'Invoke-MalSCCM' || evt.Parsed.CommandLine contains 'Invoke-Mimikatz' || evt.Parsed.CommandLine contains 'Invoke-Mimikittenz' || evt.Parsed.CommandLine contains 'Invoke-MITM6' || evt.Parsed.CommandLine contains 'Invoke-NanoDump' || evt.Parsed.CommandLine contains 'Invoke-NetRipper' || evt.Parsed.CommandLine contains 'Invoke-Nightmare' || evt.Parsed.CommandLine contains 'Invoke-NinjaCopy' || evt.Parsed.CommandLine contains 'Invoke-OfficeScrape' || evt.Parsed.CommandLine contains 'Invoke-OxidResolver' || evt.Parsed.CommandLine contains 'Invoke-P0wnedshell' || evt.Parsed.CommandLine contains 'Invoke-Paranoia' || evt.Parsed.CommandLine contains 'Invoke-PortScan' || evt.Parsed.CommandLine contains 'Invoke-PoshRatHttp' || evt.Parsed.CommandLine contains 'Invoke-PostExfil' || evt.Parsed.CommandLine contains 'Invoke-PowerDump' || evt.Parsed.CommandLine contains 'Invoke-PowerShellTCP' || evt.Parsed.CommandLine contains 'Invoke-PowerShellWMI' || evt.Parsed.CommandLine contains 'Invoke-PPLDump' || evt.Parsed.CommandLine contains 'Invoke-PsExec' || evt.Parsed.CommandLine contains 'Invoke-PSInject' || evt.Parsed.CommandLine contains 'Invoke-PsUaCme' || evt.Parsed.CommandLine contains 'Invoke-ReflectivePEInjection' || evt.Parsed.CommandLine contains 'Invoke-ReverseDNSLookup' || evt.Parsed.CommandLine contains 'Invoke-Rubeus' || evt.Parsed.CommandLine contains 'Invoke-RunAs' || evt.Parsed.CommandLine contains 'Invoke-SafetyKatz' || evt.Parsed.CommandLine contains 'Invoke-SauronEye' || evt.Parsed.CommandLine contains 'Invoke-SCShell' || evt.Parsed.CommandLine contains 'Invoke-Seatbelt' || evt.Parsed.CommandLine contains 'Invoke-ServiceAbuse' || evt.Parsed.CommandLine contains 'Invoke-ShadowSpray' || evt.Parsed.CommandLine contains 'Invoke-Sharp' || evt.Parsed.CommandLine contains 'Invoke-Shellcode' || evt.Parsed.CommandLine contains 'Invoke-SMBScanner' || evt.Parsed.CommandLine contains 'Invoke-Snaffler' || evt.Parsed.CommandLine contains 'Invoke-Spoolsample' || evt.Parsed.CommandLine contains 'Invoke-SpraySinglePassword' || evt.Parsed.CommandLine contains 'Invoke-SSHCommand' || evt.Parsed.CommandLine contains 'Invoke-StandIn' || evt.Parsed.CommandLine contains 'Invoke-StickyNotesExtract' || evt.Parsed.CommandLine contains 'Invoke-SystemCommand' || evt.Parsed.CommandLine contains 'Invoke-Tasksbackdoor' || evt.Parsed.CommandLine contains 'Invoke-Tater' || evt.Parsed.CommandLine contains 'Invoke-Thunderfox' || evt.Parsed.CommandLine contains 'Invoke-ThunderStruck' || evt.Parsed.CommandLine contains 'Invoke-TokenManipulation' || evt.Parsed.CommandLine contains 'Invoke-Tokenvator' || evt.Parsed.CommandLine contains 'Invoke-TotalExec' || evt.Parsed.CommandLine contains 'Invoke-UrbanBishop' || evt.Parsed.CommandLine contains 'Invoke-UserHunter' || evt.Parsed.CommandLine contains 'Invoke-VoiceTroll' || evt.Parsed.CommandLine contains 'Invoke-Whisker' || evt.Parsed.CommandLine contains 'Invoke-WinEnum' || evt.Parsed.CommandLine contains 'Invoke-winPEAS' || evt.Parsed.CommandLine contains 'Invoke-WireTap' || evt.Parsed.CommandLine contains 'Invoke-WmiCommand' || evt.Parsed.CommandLine contains 'Invoke-WMIExec' || evt.Parsed.CommandLine contains 'Invoke-WScriptBypassUAC' || evt.Parsed.CommandLine contains 'Invoke-Zerologon' || evt.Parsed.CommandLine contains 'MailRaider' || evt.Parsed.CommandLine contains 'New-ADIDNSNode' || evt.Parsed.CommandLine contains 'New-DNSRecordArray' || evt.Parsed.CommandLine contains 'New-HoneyHash' || evt.Parsed.CommandLine contains 'New-InMemoryModule' || evt.Parsed.CommandLine contains 'New-MachineAccount' || evt.Parsed.CommandLine contains 'New-SOASerialNumberArray' || evt.Parsed.CommandLine contains 'Out-Minidump' || evt.Parsed.CommandLine contains 'Port-Scan' || evt.Parsed.CommandLine contains 'PowerBreach' || evt.Parsed.CommandLine contains 'powercat ' || evt.Parsed.CommandLine contains 'PowerUp' || evt.Parsed.CommandLine contains 'PowerView' || evt.Parsed.CommandLine contains 'Remove-ADIDNSNode' || evt.Parsed.CommandLine contains 'Remove-MachineAccount' || evt.Parsed.CommandLine contains 'Remove-Update' || evt.Parsed.CommandLine contains 'Rename-ADIDNSNode' || evt.Parsed.CommandLine contains 'Revoke-ADIDNSPermission' || evt.Parsed.CommandLine contains 'Set-ADIDNSNode' || evt.Parsed.CommandLine contains 'Set-MacAttribute' || evt.Parsed.CommandLine contains 'Set-MachineAccountAttribute' || evt.Parsed.CommandLine contains 'Set-Wallpaper' || evt.Parsed.CommandLine contains 'Show-TargetScreen' || evt.Parsed.CommandLine contains 'Start-CaptureServer' || evt.Parsed.CommandLine contains 'Start-WebcamRecorder' || evt.Parsed.CommandLine contains 'VolumeShadowCopyTools')
blackhole: 2m
#status: experimental
labels:
  service: windows
  confidence: 0
  spoofable: 0
#  classification:
#  - attack.t1482
#  - attack.t1087
#  - attack.t1087.001
#  - attack.t1087.002
#  - attack.t1069.001
#  - attack.t1069.002
#  - attack.t1069
#  - attack.t1059.001

  label: "Malicious PowerShell Commandlets - ProcessCreation"
  behavior : "windows:audit"
  remediation: false

scope:
  type: ParentProcessId
  expression: evt.Parsed.ParentProcessId

