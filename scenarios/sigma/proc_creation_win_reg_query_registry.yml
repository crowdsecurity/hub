type: trigger
name: sigma/proc_creation_win_reg_query_registry
description: |
  Detects the usage of "reg.exe" in order to query reconnaissance information from the registry. Adversaries may interact with the Windows registry to gather information about credentials, the system, configuration, and installed software.
filter: |
  (evt.Meta.service == 'sysmon' && evt.Parsed.EventID == '1') && ((evt.Parsed.Image endsWith '\\reg.exe' || evt.Parsed.OriginalFileName == 'reg.exe') && evt.Parsed.CommandLine contains 'query' && (evt.Parsed.CommandLine contains 'currentVersion\\windows' || evt.Parsed.CommandLine contains 'winlogon\\' || evt.Parsed.CommandLine contains 'currentVersion\\shellServiceObjectDelayLoad' || evt.Parsed.CommandLine contains 'currentVersion\\run' || evt.Parsed.CommandLine contains 'currentVersion\\policies\\explorer\\run' || evt.Parsed.CommandLine contains 'currentcontrolset\\services'))
blackhole: 2m
#status: test
labels:
  service: windows
  confidence: 1
  spoofable: 0
#  classification:
#  - attack.t1012
#  - attack.t1007

  label: "Potential Configuration And Service Reconnaissance Via Reg.EXE"
  behavior : "windows:audit"
  remediation: false

scope:
  type: ParentProcessId
  expression: evt.Parsed.ParentProcessId

