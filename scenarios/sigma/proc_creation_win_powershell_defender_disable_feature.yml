type: trigger
name: sigma/proc_creation_win_powershell_defender_disable_feature
description: |
  Detects requests to disable Microsoft Defender features using PowerShell commands
filter: |
  (evt.Meta.service == 'sysmon' && evt.Parsed.EventID == '1') && ((evt.Parsed.CommandLine contains 'Add-MpPreference ' || evt.Parsed.CommandLine contains 'Set-MpPreference ') && (evt.Parsed.CommandLine contains 'DisableRealtimeMonitoring ' || evt.Parsed.CommandLine contains 'DisableIOAVProtection ' || evt.Parsed.CommandLine contains 'DisableBehaviorMonitoring ' || evt.Parsed.CommandLine contains 'DisableBlockAtFirstSeen ') && (evt.Parsed.CommandLine contains '$true' || evt.Parsed.CommandLine contains ' 1 ') || (evt.Parsed.CommandLine contains 'RGlzYWJsZVJlYWx0aW1lTW9uaXRvcmluZy' || evt.Parsed.CommandLine contains 'Rpc2FibGVSZWFsdGltZU1vbml0b3Jpbmcg' || evt.Parsed.CommandLine contains 'EaXNhYmxlUmVhbHRpbWVNb25pdG9yaW5nI' || evt.Parsed.CommandLine contains 'RGlzYWJsZUlPQVZQcm90ZWN0aW9uI' || evt.Parsed.CommandLine contains 'Rpc2FibGVJT0FWUHJvdGVjdGlvbi' || evt.Parsed.CommandLine contains 'EaXNhYmxlSU9BVlByb3RlY3Rpb24g' || evt.Parsed.CommandLine contains 'RGlzYWJsZUJlaGF2aW9yTW9uaXRvcmluZy' || evt.Parsed.CommandLine contains 'Rpc2FibGVCZWhhdmlvck1vbml0b3Jpbmcg' || evt.Parsed.CommandLine contains 'EaXNhYmxlQmVoYXZpb3JNb25pdG9yaW5nI' || evt.Parsed.CommandLine contains 'RGlzYWJsZUJsb2NrQXRGaXJzdFNlZW4g' || evt.Parsed.CommandLine contains 'Rpc2FibGVCbG9ja0F0Rmlyc3RTZWVuI' || evt.Parsed.CommandLine contains 'EaXNhYmxlQmxvY2tBdEZpcnN0U2Vlbi' || evt.Parsed.CommandLine contains 'ZGlzYWJsZXJlYWx0aW1lbW9uaXRvcmluZy' || evt.Parsed.CommandLine contains 'Rpc2FibGVyZWFsdGltZW1vbml0b3Jpbmcg' || evt.Parsed.CommandLine contains 'kaXNhYmxlcmVhbHRpbWVtb25pdG9yaW5nI' || evt.Parsed.CommandLine contains 'ZGlzYWJsZWlvYXZwcm90ZWN0aW9uI' || evt.Parsed.CommandLine contains 'Rpc2FibGVpb2F2cHJvdGVjdGlvbi' || evt.Parsed.CommandLine contains 'kaXNhYmxlaW9hdnByb3RlY3Rpb24g' || evt.Parsed.CommandLine contains 'ZGlzYWJsZWJlaGF2aW9ybW9uaXRvcmluZy' || evt.Parsed.CommandLine contains 'Rpc2FibGViZWhhdmlvcm1vbml0b3Jpbmcg' || evt.Parsed.CommandLine contains 'kaXNhYmxlYmVoYXZpb3Jtb25pdG9yaW5nI' || evt.Parsed.CommandLine contains 'ZGlzYWJsZWJsb2NrYXRmaXJzdHNlZW4g' || evt.Parsed.CommandLine contains 'Rpc2FibGVibG9ja2F0Zmlyc3RzZWVuI' || evt.Parsed.CommandLine contains 'kaXNhYmxlYmxvY2thdGZpcnN0c2Vlbi') && (evt.Parsed.CommandLine contains 'RABpAHMAYQBiAGwAZQBSAGUAYQBsAHQAaQBtAGUATQBvAG4AaQB0AG8AcgBpAG4AZwAgA' || evt.Parsed.CommandLine contains 'QAaQBzAGEAYgBsAGUAUgBlAGEAbAB0AGkAbQBlAE0AbwBuAGkAdABvAHIAaQBuAGcAIA' || evt.Parsed.CommandLine contains 'EAGkAcwBhAGIAbABlAFIAZQBhAGwAdABpAG0AZQBNAG8AbgBpAHQAbwByAGkAbgBnACAA' || evt.Parsed.CommandLine contains 'RABpAHMAYQBiAGwAZQBJAE8AQQBWAFAAcgBvAHQAZQBjAHQAaQBvAG4AIA' || evt.Parsed.CommandLine contains 'QAaQBzAGEAYgBsAGUASQBPAEEAVgBQAHIAbwB0AGUAYwB0AGkAbwBuACAA' || evt.Parsed.CommandLine contains 'EAGkAcwBhAGIAbABlAEkATwBBAFYAUAByAG8AdABlAGMAdABpAG8AbgAgA' || evt.Parsed.CommandLine contains 'RABpAHMAYQBiAGwAZQBCAGUAaABhAHYAaQBvAHIATQBvAG4AaQB0AG8AcgBpAG4AZwAgA' || evt.Parsed.CommandLine contains 'QAaQBzAGEAYgBsAGUAQgBlAGgAYQB2AGkAbwByAE0AbwBuAGkAdABvAHIAaQBuAGcAIA' || evt.Parsed.CommandLine contains 'EAGkAcwBhAGIAbABlAEIAZQBoAGEAdgBpAG8AcgBNAG8AbgBpAHQAbwByAGkAbgBnACAA' || evt.Parsed.CommandLine contains 'RABpAHMAYQBiAGwAZQBCAGwAbwBjAGsAQQB0AEYAaQByAHMAdABTAGUAZQBuACAA' || evt.Parsed.CommandLine contains 'QAaQBzAGEAYgBsAGUAQgBsAG8AYwBrAEEAdABGAGkAcgBzAHQAUwBlAGUAbgAgA' || evt.Parsed.CommandLine contains 'EAGkAcwBhAGIAbABlAEIAbABvAGMAawBBAHQARgBpAHIAcwB0AFMAZQBlAG4AIA' || evt.Parsed.CommandLine contains 'ZABpAHMAYQBiAGwAZQByAGUAYQBsAHQAaQBtAGUAbQBvAG4AaQB0AG8AcgBpAG4AZwAgA' || evt.Parsed.CommandLine contains 'QAaQBzAGEAYgBsAGUAcgBlAGEAbAB0AGkAbQBlAG0AbwBuAGkAdABvAHIAaQBuAGcAIA' || evt.Parsed.CommandLine contains 'kAGkAcwBhAGIAbABlAHIAZQBhAGwAdABpAG0AZQBtAG8AbgBpAHQAbwByAGkAbgBnACAA' || evt.Parsed.CommandLine contains 'ZABpAHMAYQBiAGwAZQBpAG8AYQB2AHAAcgBvAHQAZQBjAHQAaQBvAG4AIA' || evt.Parsed.CommandLine contains 'QAaQBzAGEAYgBsAGUAaQBvAGEAdgBwAHIAbwB0AGUAYwB0AGkAbwBuACAA' || evt.Parsed.CommandLine contains 'kAGkAcwBhAGIAbABlAGkAbwBhAHYAcAByAG8AdABlAGMAdABpAG8AbgAgA' || evt.Parsed.CommandLine contains 'ZABpAHMAYQBiAGwAZQBiAGUAaABhAHYAaQBvAHIAbQBvAG4AaQB0AG8AcgBpAG4AZwAgA' || evt.Parsed.CommandLine contains 'QAaQBzAGEAYgBsAGUAYgBlAGgAYQB2AGkAbwByAG0AbwBuAGkAdABvAHIAaQBuAGcAIA' || evt.Parsed.CommandLine contains 'kAGkAcwBhAGIAbABlAGIAZQBoAGEAdgBpAG8AcgBtAG8AbgBpAHQAbwByAGkAbgBnACAA' || evt.Parsed.CommandLine contains 'ZABpAHMAYQBiAGwAZQBiAGwAbwBjAGsAYQB0AGYAaQByAHMAdABzAGUAZQBuACAA' || evt.Parsed.CommandLine contains 'QAaQBzAGEAYgBsAGUAYgBsAG8AYwBrAGEAdABmAGkAcgBzAHQAcwBlAGUAbgAgA' || evt.Parsed.CommandLine contains 'kAGkAcwBhAGIAbABlAGIAbABvAGMAawBhAHQAZgBpAHIAcwB0AHMAZQBlAG4AIA'))
blackhole: 2m
#status: test
labels:
  service: windows
  confidence: 1
  spoofable: 0
#  classification:
#  - attack.t1562.001

  label: "Powershell Defender Disable Scan Feature"
  behavior : "windows:audit"
  remediation: false

scope:
  type: ParentProcessId
  expression: evt.Parsed.ParentProcessId

