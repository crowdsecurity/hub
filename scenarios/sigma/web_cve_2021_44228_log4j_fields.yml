type: trigger
name: sigma/web_cve_2021_44228_log4j_fields
description: |
  Detects exploitation attempt against log4j RCE vulnerability reported as CVE-2021-44228 in different header fields found in web server logs (Log4Shell)
filter: |
  evt.Meta.service == 'http' && ((evt.Meta.http_user_agent contains "${jndi:ldap:/" || evt.Meta.http_user_agent contains "${jndi:rmi:/" || evt.Meta.http_user_agent contains "${jndi:ldaps:/" || evt.Meta.http_user_agent contains "${jndi:dns:/" || evt.Meta.http_user_agent contains "/$%7bjndi:" || evt.Meta.http_user_agent contains "%24%7bjndi:" || evt.Meta.http_user_agent contains "$%7Bjndi:" || evt.Meta.http_user_agent contains "%2524%257Bjndi" || evt.Meta.http_user_agent contains "%2F%252524%25257Bjndi%3A" || evt.Meta.http_user_agent contains "${jndi:${lower:" || evt.Meta.http_user_agent contains "${::-j}${" || evt.Meta.http_user_agent contains "${jndi:nis" || evt.Meta.http_user_agent contains "${jndi:nds" || evt.Meta.http_user_agent contains "${jndi:corba" || evt.Meta.http_user_agent contains "${jndi:iiop" || evt.Meta.http_user_agent contains "Reference Class Name: foo" || evt.Meta.http_user_agent contains "${${env:BARFOO:-j}" || evt.Meta.http_user_agent contains "${::-l}${::-d}${::-a}${::-p}" || evt.Meta.http_user_agent contains "${base64:JHtqbmRp" || evt.Meta.http_user_agent contains "${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}$" || evt.Meta.http_user_agent contains "${${lower:j}ndi:" || evt.Meta.http_user_agent contains "${${upper:j}ndi:" || evt.Meta.http_user_agent contains "${${::-j}${::-n}${::-d}${::-i}:") || (evt.Parsed.http_args contains "${jndi:ldap:/" || evt.Parsed.http_args contains "${jndi:rmi:/" || evt.Parsed.http_args contains "${jndi:ldaps:/" || evt.Parsed.http_args contains "${jndi:dns:/" || evt.Parsed.http_args contains "/$%7bjndi:" || evt.Parsed.http_args contains "%24%7bjndi:" || evt.Parsed.http_args contains "$%7Bjndi:" || evt.Parsed.http_args contains "%2524%257Bjndi" || evt.Parsed.http_args contains "%2F%252524%25257Bjndi%3A" || evt.Parsed.http_args contains "${jndi:${lower:" || evt.Parsed.http_args contains "${::-j}${" || evt.Parsed.http_args contains "${jndi:nis" || evt.Parsed.http_args contains "${jndi:nds" || evt.Parsed.http_args contains "${jndi:corba" || evt.Parsed.http_args contains "${jndi:iiop" || evt.Parsed.http_args contains "Reference Class Name: foo" || evt.Parsed.http_args contains "${${env:BARFOO:-j}" || evt.Parsed.http_args contains "${::-l}${::-d}${::-a}${::-p}" || evt.Parsed.http_args contains "${base64:JHtqbmRp" || evt.Parsed.http_args contains "${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}$" || evt.Parsed.http_args contains "${${lower:j}ndi:" || evt.Parsed.http_args contains "${${upper:j}ndi:" || evt.Parsed.http_args contains "${${::-j}${::-n}${::-d}${::-i}:") || (evt.Parsed.http_referer contains "${jndi:ldap:/" || evt.Parsed.http_referer contains "${jndi:rmi:/" || evt.Parsed.http_referer contains "${jndi:ldaps:/" || evt.Parsed.http_referer contains "${jndi:dns:/" || evt.Parsed.http_referer contains "/$%7bjndi:" || evt.Parsed.http_referer contains "%24%7bjndi:" || evt.Parsed.http_referer contains "$%7Bjndi:" || evt.Parsed.http_referer contains "%2524%257Bjndi" || evt.Parsed.http_referer contains "%2F%252524%25257Bjndi%3A" || evt.Parsed.http_referer contains "${jndi:${lower:" || evt.Parsed.http_referer contains "${::-j}${" || evt.Parsed.http_referer contains "${jndi:nis" || evt.Parsed.http_referer contains "${jndi:nds" || evt.Parsed.http_referer contains "${jndi:corba" || evt.Parsed.http_referer contains "${jndi:iiop" || evt.Parsed.http_referer contains "Reference Class Name: foo" || evt.Parsed.http_referer contains "${${env:BARFOO:-j}" || evt.Parsed.http_referer contains "${::-l}${::-d}${::-a}${::-p}" || evt.Parsed.http_referer contains "${base64:JHtqbmRp" || evt.Parsed.http_referer contains "${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}$" || evt.Parsed.http_referer contains "${${lower:j}ndi:" || evt.Parsed.http_referer contains "${${upper:j}ndi:" || evt.Parsed.http_referer contains "${${::-j}${::-n}${::-d}${::-i}:"))
blackhole: 2m
labels:
  type: exploit
  remediation: true
